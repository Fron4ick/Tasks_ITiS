<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞–Ω–∏–µ 1.3: –ê–Ω–∞–ª–∏–∑ –≤—ã—Ä—É—á–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-secondary: #666;
            --accent-blue: #36a2eb;
            --accent-pink: #ff6384;
            --border-color: #eee;
            --table-hover: #f1f1f1;
            --table-even: #f9f9f9;
            --header-bg: #34495e;
            --stat-border: #36a2eb;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-blue: #4fc3f7;
            --accent-pink: #ff7597;
            --border-color: #404040;
            --table-hover: #3a3a3a;
            --table-even: #333;
            --header-bg: #1f2937;
            --stat-border: #4fc3f7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Theme Toggle --- */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-toggle-btn {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-main);
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .theme-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .theme-icon {
            font-size: 18px;
        }

        /* --- Header & Upload --- */
        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .file-upload {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: inline-block;
            transition: background-color 0.3s;
        }

        h1, h2 {
            font-weight: 600;
            color: var(--text-main);
            transition: color 0.3s;
        }

        /* --- Dashboard Cards --- */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 30px;
            transition: background-color 0.3s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-main);
            transition: all 0.3s;
        }

        input[type="file"] {
            color: var(--text-main);
        }

        button.action-btn {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button.action-btn:hover { background-color: #2980b9; }

        /* --- Layout: Table & Pie Chart --- */
        .dashboard-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .col-table {
            flex: 1;
            min-width: 300px;
            max-height: 500px;
            overflow-y: auto;
        }

        .col-chart {
            flex: 1;
            min-width: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Table Styling --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background-color: var(--header-bg);
            color: white;
            position: sticky;
            top: 0;
            padding: 10px;
            text-align: left;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            transition: background-color 0.3s;
        }

        tr:nth-child(even) { background-color: var(--table-even); }
        tr:hover { background-color: var(--table-hover); }

        .rank-col { width: 40px; text-align: center; color: var(--text-secondary); }
        .money-col { font-family: monospace; font-weight: 600; }

        /* --- Summary Cards --- */
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            background: var(--card-bg);
            padding: 15px;
            border-left: 4px solid var(--stat-border);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-box h4 { margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; }
        .stat-box .value { font-size: 20px; font-weight: bold; color: var(--text-main); }

        /* --- Comparison Section --- */
        .comparison-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .chart-container-bar {
            height: 400px;
            width: 100%;
        }

        /* --- Utility --- */
        .hidden { display: none; }
        .file-label { cursor: pointer; color: var(--accent-blue); text-decoration: underline; }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

    </style>
</head>
<body>

<div class="theme-toggle">
    <button class="theme-toggle-btn" id="themeToggle">
        <span class="theme-icon">üåô</span>
        <span id="themeText">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
    </button>
</div>

<div class="container">
    
    <div class="header-section">
        <h1>–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞</h1>
        <div class="file-upload">
            <label for="csvFileInput">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª <strong>orders_customers.csv</strong>: </label>
            <input type="file" id="csvFileInput" accept=".csv" />
            <div id="autoLoadStatus" class="loading hidden"></div>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        
        <div class="card">
            <div class="card-header">
                <h2>–ê–Ω–∞–ª–∏–∑ –≤—ã—Ä—É—á–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º</h2>
                <div>
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥: </label>
                    <select id="yearSelect"></select>
                </div>
            </div>

            <h3 style="text-align:center; margin-bottom:20px;">–í—ã—Ä—É—á–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º –∑–∞ <span id="displayYear">...</span> –≥–æ–¥</h3>

            <div class="dashboard-row">
                <div class="col-table">
                    <table id="citiesTable">
                        <thead>
                            <tr>
                                <th>‚Ññ</th>
                                <th>–ì–æ—Ä–æ–¥ / –®—Ç–∞—Ç</th>
                                <th>–ó–∞–∫–∞–∑—ã</th>
                                <th>–í—ã—Ä—É—á–∫–∞</th>
                                <th>–î–æ–ª—è %</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="col-chart">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="summary-stats">
                <div class="stat-box">
                    <h4>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h4>
                    <div class="value" id="statTotalRevenue">$0</div>
                </div>
                <div class="stat-box">
                    <h4>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</h4>
                    <div class="value" id="statTotalOrders">0</div>
                </div>
                <div class="stat-box">
                    <h4>–í—ã—Ä—É—á–∫–∞ (–¢–æ–ø-10)</h4>
                    <div class="value" id="statTop10Rev">$0</div>
                </div>
                <div class="stat-box">
                    <h4>–î–æ–ª—è (–¢–æ–ø-10)</h4>
                    <div class="value" id="statTop10Share">0%</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –≥–æ–¥–∞–º</h2>
            </div>
            
            <div class="comparison-controls">
                <div>
                    <label>–ì–æ—Ä–æ–¥ 1:</label>
                    <select id="city1Select"></select>
                </div>
                <div>
                    <label>–ì–æ—Ä–æ–¥ 2:</label>
                    <select id="city2Select"></select>
                </div>
                <button class="action-btn" id="compareBtn">–°—Ä–∞–≤–Ω–∏—Ç—å –≥–æ—Ä–æ–¥–∞</button>
            </div>

            <h3 style="text-align:center;">–î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏ –ø–æ –≥–æ–¥–∞–º</h3>
            <div class="chart-container-bar">
                <canvas id="barChart"></canvas>
            </div>
        </div>

    </div>
</div>

<script>
    // --- Global Data Storage ---
    let rawData = [];
    let citiesMap = {};
    let yearsSet = new Set();
    let pieChartInstance = null;
    let barChartInstance = null;
    let currentTheme = 'light';

    // --- Theme Toggle ---
    const themeToggle = document.getElementById('themeToggle');
    const themeText = document.getElementById('themeText');
    const themeIcon = document.querySelector('.theme-icon');

    themeToggle.addEventListener('click', () => {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        if (currentTheme === 'dark') {
            themeIcon.textContent = '‚òÄÔ∏è';
            themeText.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        } else {
            themeIcon.textContent = 'üåô';
            themeText.textContent = '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞';
        }

        // Update charts with new theme colors
        if (pieChartInstance) {
            updateChartTheme(pieChartInstance);
        }
        if (barChartInstance) {
            updateChartTheme(barChartInstance);
        }
    });

    function updateChartTheme(chart) {
        const isDark = currentTheme === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#eee';

        if (chart.options.scales) {
            if (chart.options.scales.x) {
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.x.grid.color = gridColor;
            }
            if (chart.options.scales.y) {
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.y.grid.color = gridColor;
            }
        }

        if (chart.options.plugins && chart.options.plugins.legend) {
            chart.options.plugins.legend.labels.color = textColor;
        }

        chart.update();
    }

    // --- Auto-load CSV on page load ---
    window.addEventListener('DOMContentLoaded', () => {
        autoLoadCSV();
    });

    async function autoLoadCSV() {
        const statusEl = document.getElementById('autoLoadStatus');
        statusEl.classList.remove('hidden');
        statusEl.textContent = '–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ orders_customers.csv...';

        try {
            const response = await fetch('orders_customers.csv');
            if (response.ok) {
                const text = await response.text();
                processData(text);
                document.getElementById('mainContent').classList.remove('hidden');
                statusEl.textContent = '‚úì –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            } else {
                throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        } catch (error) {
            statusEl.textContent = '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.';
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }
    }

    // --- CSV Parser Function ---
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }

    // --- File Upload Handler ---
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            const text = evt.target.result;
            processData(text);
            document.getElementById('mainContent').classList.remove('hidden');
        };
        reader.readAsText(file);
    });

    function processData(csvText) {
        const lines = csvText.split('\n');
        
        // Reset
        rawData = [];
        citiesMap = {};
        yearsSet.clear();

        // Skip header
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const cols = parseCSVLine(line);

            if (cols.length < 7) continue;

            // Extract data: name,segment,state,city,order_date,ship_mode,sales
            const state = cols[2].replace(/^"|"$/g, '').trim();
            const city = cols[3].replace(/^"|"$/g, '').trim();
            const dateStr = cols[4].replace(/^"|"$/g, '').trim();
            const salesStr = cols[6].replace(/^"|"$/g, '').trim();

            const year = new Date(dateStr).getFullYear();
            const sales = parseFloat(salesStr);

            if (isNaN(year) || isNaN(sales)) continue;

            yearsSet.add(year);

            const cityKey = `${city}, ${state}`;

            if (!citiesMap[cityKey]) {
                citiesMap[cityKey] = {
                    name: city,
                    state: state,
                    key: cityKey,
                    years: {}
                };
            }

            if (!citiesMap[cityKey].years[year]) {
                citiesMap[cityKey].years[year] = { revenue: 0, orders: 0 };
            }

            citiesMap[cityKey].years[year].revenue += sales;
            citiesMap[cityKey].years[year].orders += 1;
        }

        initDashboard();
    }

    function initDashboard() {
        // 1. Populate Year Dropdown
        const years = Array.from(yearsSet).sort((a, b) => b - a);
        const yearSelect = document.getElementById('yearSelect');
        yearSelect.innerHTML = '';
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            yearSelect.appendChild(opt);
        });

        // 2. Populate City Dropdowns for Comparison
        const cityKeys = Object.keys(citiesMap).sort();
        const city1Select = document.getElementById('city1Select');
        const city2Select = document.getElementById('city2Select');
        city1Select.innerHTML = '';
        city2Select.innerHTML = '';

        cityKeys.forEach(k => {
            const opt1 = document.createElement('option');
            opt1.value = k;
            opt1.innerText = k;
            city1Select.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = k;
            opt2.innerText = k;
            city2Select.appendChild(opt2);
        });

        // Set defaults
        if (cityKeys.includes("New York City, New York")) city1Select.value = "New York City, New York";
        if (cityKeys.includes("Los Angeles, California")) city2Select.value = "Los Angeles, California";

        // Listeners
        yearSelect.addEventListener('change', renderYearView);
        document.getElementById('compareBtn').addEventListener('click', renderComparison);

        // Initial Render
        renderYearView();
        renderComparison();
    }

    // --- Logic for Page 1: Yearly Analysis ---
    function renderYearView() {
        const year = parseInt(document.getElementById('yearSelect').value);
        document.getElementById('displayYear').innerText = year;

        let yearData = [];
        let totalRevenue = 0;
        let totalOrders = 0;

        Object.values(citiesMap).forEach(city => {
            if (city.years[year]) {
                const rev = city.years[year].revenue;
                const ord = city.years[year].orders;
                totalRevenue += rev;
                totalOrders += ord;
                yearData.push({
                    key: city.key,
                    display: `${city.name}<br><small style="color:${currentTheme === 'dark' ? '#b0b0b0' : '#888'}">${city.state}</small>`,
                    revenue: rev,
                    orders: ord
                });
            }
        });

        yearData.sort((a, b) => b.revenue - a.revenue);
        yearData.forEach(d => d.share = (d.revenue / totalRevenue * 100).toFixed(2));

        // Render Table
        const tbody = document.querySelector('#citiesTable tbody');
        tbody.innerHTML = '';
        yearData.forEach((d, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="rank-col">${index + 1}</td>
                <td>${d.display}</td>
                <td>${d.orders}</td>
                <td class="money-col">$${d.revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${d.share}%</td>
            `;
            tbody.appendChild(tr);
        });

        // Prepare Data for Pie Chart (Top 10 + Others)
        let top10 = yearData.slice(0, 10);
        let others = yearData.slice(10);
        
        let top10Rev = top10.reduce((acc, curr) => acc + curr.revenue, 0);
        let othersRev = others.reduce((acc, curr) => acc + curr.revenue, 0);

        // Update Summary Stats
        document.getElementById('statTotalRevenue').innerText = "$" + totalRevenue.toLocaleString('en-US', {maximumFractionDigits: 2});
        document.getElementById('statTotalOrders').innerText = totalOrders;
        document.getElementById('statTop10Rev').innerText = "$" + top10Rev.toLocaleString('en-US', {maximumFractionDigits: 2});
        document.getElementById('statTop10Share').innerText = (top10Rev / totalRevenue * 100).toFixed(1) + "%";

        // ChartJS Pie with Percentages
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChartInstance) pieChartInstance.destroy();

        const labels = top10.map(d => d.key.split(',')[0]);
        const data = top10.map(d => d.revenue);
        
        if (othersRev > 0) {
            labels.push('–û—Å—Ç–∞–ª—å–Ω—ã–µ');
            data.push(othersRev);
        }

        const colors = [
            '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', 
            '#ff9f40', '#e7e9ed', '#76b852', '#00d2d3', '#5f27cd', '#c8d6e5'
        ];

        const isDark = currentTheme === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';

        pieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: {
                            color: textColor
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 14
                        },
                        formatter: (value, ctx) => {
                            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = (value * 100 / sum).toFixed(1) + '%';
                            return percentage;
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // --- Logic for Page 2: Comparison ---
    function renderComparison() {
        const city1Key = document.getElementById('city1Select').value;
        const city2Key = document.getElementById('city2Select').value;

        const city1 = citiesMap[city1Key];
        const city2 = citiesMap[city2Key];

        const allYears = Array.from(yearsSet).sort();

        const data1 = allYears.map(y => (city1.years[y] ? city1.years[y].revenue : 0));
        const data2 = allYears.map(y => (city2.years[y] ? city2.years[y].revenue : 0));

        const ctx = document.getElementById('barChart').getContext('2d');
        if (barChartInstance) barChartInstance.destroy();

        const isDark = currentTheme === 'dark';
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? '#404040' : '#eee';

        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: allYears,
                datasets: [
                    {
                        label: city1.name,
                        data: data1,
                        backgroundColor: '#36a2eb'
                    },
                    {
                        label: city2.name,
                        data: data2,
                        backgroundColor: '#ff6384'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    },
                    datalabels: {
                        display: false
                    }
                }
            }
        });
    }
</script>

</body>
</html>